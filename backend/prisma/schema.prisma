generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────────────────────────

enum Role {
  student
  recruiter
  admin
}

enum ApplicationStatus {
  applied
  shortlisted
  interviewing
  offered
  rejected
  withdrawn
}

enum JobType {
  full_time
  part_time
  contract
  internship
}

enum JobVisibility {
  public
  private
  draft
}

enum DriveStatus {
  upcoming
  ongoing
  completed
  cancelled
}

enum StudentStatus {
  active
  inactive
  graduated
  placed
}

// ─────────────────────────────────────────────────────────────────
// USERS (base auth table for all roles)
// ─────────────────────────────────────────────────────────────────

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         Role
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  student       Student?
  recruiter     Recruiter?
  admin         Admin?
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role])
  @@index([deletedAt])
  @@map("users")
}

// ─────────────────────────────────────────────────────────────────
// REFRESH TOKENS
// ─────────────────────────────────────────────────────────────────

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  userId    String   @map("user_id") @db.Uuid
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ─────────────────────────────────────────────────────────────────
// STUDENTS
// ─────────────────────────────────────────────────────────────────

model Student {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @unique @map("user_id") @db.Uuid
  fullName          String        @map("full_name")
  studentId         String        @unique @map("student_id")
  department        String
  yearOfStudy       String        @map("year_of_study")
  gpa               Decimal?      @db.Decimal(3, 2)
  phone             String?
  linkedin          String?
  website           String?
  location          String?
  expectedGrad      String?       @map("expected_grad")
  bio               String?
  avatarUrl         String?       @map("avatar_url")
  githubUsername    String?       @map("github_username")
  leetcodeUsername  String?       @map("leetcode_username")
  linkedinPdfUrl    String?       @map("linkedin_pdf_url")
  showOnLeaderboard Boolean       @default(true) @map("show_on_leaderboard")
  profileCompletion Int           @default(0) @map("profile_completion")
  readinessScore    Decimal       @default(0) @db.Decimal(5, 2) @map("readiness_score")
  status            StudentStatus @default(active)
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  skills         StudentSkill[]
  assessments    Assessment[]
  applications   Application[]
  rankings       Ranking[]
  scoreBreakdown ScoreBreakdown?
  projects       Project[]
  internships    Internship[]
  certifications Certification[]
  placements     Placement[]
  resumes        Resume[]

  @@index([department])
  @@index([readinessScore])
  @@index([status])
  @@index([yearOfStudy])
  @@index([deletedAt])
  @@map("students")
}

// ─────────────────────────────────────────────────────────────────
// RESUMES (multiple resumes per student, categorized)
// ─────────────────────────────────────────────────────────────────

model Resume {
  id          String   @id @default(uuid()) @db.Uuid
  studentId   String   @map("student_id") @db.Uuid
  name        String
  category    String   @default("general")
  url         String
  publicId    String   @map("public_id")
  isDefault   Boolean  @default(false) @map("is_default")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("resumes")
}

// ─────────────────────────────────────────────────────────────────
// RECRUITERS
// ─────────────────────────────────────────────────────────────────

model Recruiter {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @unique @map("user_id") @db.Uuid
  fullName    String    @map("full_name")
  companyId   String    @map("company_id") @db.Uuid
  designation String?
  phone       String?
  avatarUrl   String?   @map("avatar_url")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  company    Company     @relation(fields: [companyId], references: [id])
  jobs       Job[]
  shortlists Shortlist[]

  @@index([companyId])
  @@index([deletedAt])
  @@map("recruiters")
}

// ─────────────────────────────────────────────────────────────────
// ADMINS
// ─────────────────────────────────────────────────────────────────

model Admin {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  fullName  String   @map("full_name")
  title     String   @default("Placement Officer")
  phone     String?
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

// ─────────────────────────────────────────────────────────────────
// COMPANIES
// ─────────────────────────────────────────────────────────────────

model Company {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @unique
  industry  String?
  website   String?
  logoUrl   String?   @map("logo_url")
  location  String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  recruiters      Recruiter[]
  jobs            Job[]
  placementDrives PlacementDrive[]
  placements      Placement[]

  @@map("companies")
}

// ─────────────────────────────────────────────────────────────────
// SKILLS
// ─────────────────────────────────────────────────────────────────

model Skill {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  category  String   @default("technical")
  createdAt DateTime @default(now()) @map("created_at")

  studentSkills StudentSkill[]
  jobSkills     JobSkill[]

  @@index([category])
  @@map("skills")
}

model StudentSkill {
  id          String  @id @default(uuid()) @db.Uuid
  studentId   String  @map("student_id") @db.Uuid
  skillId     String  @map("skill_id") @db.Uuid
  proficiency Int     @default(0)
  level       String? @default("Beginner")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([studentId, skillId])
  @@index([studentId])
  @@map("student_skills")
}

// ─────────────────────────────────────────────────────────────────
// PROJECTS
// ─────────────────────────────────────────────────────────────────

model Project {
  id          String    @id @default(uuid()) @db.Uuid
  studentId   String    @map("student_id") @db.Uuid
  title       String
  description String?
  tags        String[]
  url         String?
  imageUrl    String?   @map("image_url")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("projects")
}

// ─────────────────────────────────────────────────────────────────
// INTERNSHIPS
// ─────────────────────────────────────────────────────────────────

model Internship {
  id          String    @id @default(uuid()) @db.Uuid
  studentId   String    @map("student_id") @db.Uuid
  company     String
  role        String
  startDate   DateTime  @map("start_date")
  endDate     DateTime? @map("end_date")
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("internships")
}

// ─────────────────────────────────────────────────────────────────
// CERTIFICATIONS
// ─────────────────────────────────────────────────────────────────

model Certification {
  id            String    @id @default(uuid()) @db.Uuid
  studentId     String    @map("student_id") @db.Uuid
  name          String
  issuer        String
  issueDate     DateTime  @map("issue_date")
  expiryDate    DateTime? @map("expiry_date")
  credentialUrl String?   @map("credential_url")
  createdAt     DateTime  @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("certifications")
}

// ─────────────────────────────────────────────────────────────────
// ASSESSMENTS
// ─────────────────────────────────────────────────────────────────

model Assessment {
  id          String   @id @default(uuid()) @db.Uuid
  studentId   String   @map("student_id") @db.Uuid
  title       String
  subtitle    String?
  category    String
  totalScore  Int      @map("total_score")
  maxScore    Int      @default(1000) @map("max_score")
  percentile  Int?
  timeTaken   Int?     @map("time_taken")
  maxTime     Int?     @map("max_time")
  status      String
  completedAt DateTime @map("completed_at")
  createdAt   DateTime @default(now()) @map("created_at")

  student Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  scores  AssessmentScore[]

  @@index([studentId])
  @@index([category])
  @@index([completedAt])
  @@map("assessments")
}

model AssessmentScore {
  id           String @id @default(uuid()) @db.Uuid
  assessmentId String @map("assessment_id") @db.Uuid
  category     String
  score        Int
  maxScore     Int    @default(100) @map("max_score")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@map("assessment_scores")
}

// ─────────────────────────────────────────────────────────────────
// SCORE WEIGHTS (configurable scoring engine weights)
// ─────────────────────────────────────────────────────────────────

model ScoreWeight {
  id        String   @id @default(uuid()) @db.Uuid
  component String   @unique
  weight    Decimal  @db.Decimal(5, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("score_weights")
}

// ─────────────────────────────────────────────────────────────────
// SCORE BREAKDOWN (per-student cached scoring components)
// ─────────────────────────────────────────────────────────────────

model ScoreBreakdown {
  id               String   @id @default(uuid()) @db.Uuid
  studentId        String   @unique @map("student_id") @db.Uuid
  technicalSkills  Decimal  @default(0) @db.Decimal(5, 2) @map("technical_skills")
  projects         Decimal  @default(0) @db.Decimal(5, 2)
  internships      Decimal  @default(0) @db.Decimal(5, 2)
  certifications   Decimal  @default(0) @db.Decimal(5, 2)
  assessments      Decimal  @default(0) @db.Decimal(5, 2)
  totalScore       Decimal  @default(0) @db.Decimal(5, 2) @map("total_score")
  lastCalculatedAt DateTime @default(now()) @map("last_calculated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("score_breakdowns")
}

// ─────────────────────────────────────────────────────────────────
// JOBS
// ─────────────────────────────────────────────────────────────────

model Job {
  id                   String        @id @default(uuid()) @db.Uuid
  recruiterId          String        @map("recruiter_id") @db.Uuid
  companyId            String        @map("company_id") @db.Uuid
  title                String
  department           String
  employmentType       JobType       @map("employment_type")
  location             String
  description          String
  minimumReadinessScore Int          @default(0) @map("minimum_readiness_score")
  visibility           JobVisibility @default(public)
  notifyEligible       Boolean       @default(false) @map("notify_eligible")
  isActive             Boolean       @default(true) @map("is_active")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  deletedAt            DateTime?     @map("deleted_at")

  recruiter    Recruiter     @relation(fields: [recruiterId], references: [id])
  company      Company       @relation(fields: [companyId], references: [id])
  skills       JobSkill[]
  applications Application[]
  rankings     Ranking[]

  @@index([recruiterId])
  @@index([companyId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("jobs")
}

model JobSkill {
  id      String @id @default(uuid()) @db.Uuid
  jobId   String @map("job_id") @db.Uuid
  skillId String @map("skill_id") @db.Uuid

  job   Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([jobId, skillId])
  @@map("job_skills")
}

// ─────────────────────────────────────────────────────────────────
// APPLICATIONS
// ─────────────────────────────────────────────────────────────────

model Application {
  id        String            @id @default(uuid()) @db.Uuid
  studentId String            @map("student_id") @db.Uuid
  jobId     String            @map("job_id") @db.Uuid
  status    ApplicationStatus @default(applied)
  appliedAt DateTime          @default(now()) @map("applied_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  job     Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([studentId, jobId])
  @@index([jobId])
  @@index([status])
  @@index([appliedAt])
  @@map("applications")
}

// ─────────────────────────────────────────────────────────────────
// SHORTLISTS (recruiter shortlisting a student for a job)
// ─────────────────────────────────────────────────────────────────

model Shortlist {
  id          String   @id @default(uuid()) @db.Uuid
  recruiterId String   @map("recruiter_id") @db.Uuid
  studentId   String   @map("student_id") @db.Uuid
  jobId       String?  @map("job_id") @db.Uuid
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  recruiter Recruiter @relation(fields: [recruiterId], references: [id], onDelete: Cascade)

  @@unique([recruiterId, studentId, jobId])
  @@index([recruiterId])
  @@index([studentId])
  @@map("shortlists")
}

// ─────────────────────────────────────────────────────────────────
// RANKINGS (global and per-job)
// ─────────────────────────────────────────────────────────────────

model Ranking {
  id           String   @id @default(uuid()) @db.Uuid
  studentId    String   @map("student_id") @db.Uuid
  jobId        String?  @map("job_id") @db.Uuid
  rank         Int
  score        Decimal  @db.Decimal(5, 2)
  calculatedAt DateTime @default(now()) @map("calculated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  job     Job?    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([studentId, jobId])
  @@index([jobId, rank])
  @@index([rank])
  @@map("rankings")
}

// ─────────────────────────────────────────────────────────────────
// PLACEMENT DRIVES
// ─────────────────────────────────────────────────────────────────

model PlacementDrive {
  id          String      @id @default(uuid()) @db.Uuid
  companyId   String      @map("company_id") @db.Uuid
  role        String
  description String?
  driveDate   DateTime    @map("drive_date")
  driveTime   String?     @map("drive_time")
  status      DriveStatus @default(upcoming)
  packageLpa  Decimal?    @db.Decimal(5, 2) @map("package_lpa")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id])

  @@index([driveDate])
  @@index([status])
  @@map("placement_drives")
}

// ─────────────────────────────────────────────────────────────────
// PLACEMENTS (confirmed final placements)
// ─────────────────────────────────────────────────────────────────

model Placement {
  id         String   @id @default(uuid()) @db.Uuid
  studentId  String   @map("student_id") @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  role       String
  packageLpa Decimal  @db.Decimal(5, 2) @map("package_lpa")
  status     String   @default("Placed")
  placedAt   DateTime @default(now()) @map("placed_at")
  createdAt  DateTime @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id])

  @@index([studentId])
  @@index([companyId])
  @@map("placements")
}

// ─────────────────────────────────────────────────────────────────
// RECRUITER INVITES (admin invites recruiters via token)
// ─────────────────────────────────────────────────────────────────

model RecruiterInvite {
  id        String    @id @default(uuid()) @db.Uuid
  email     String    @unique
  token     String    @unique
  companyId String    @map("company_id") @db.Uuid
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([token])
  @@map("recruiter_invites")
}

// ─────────────────────────────────────────────────────────────────
// AUDIT LOGS
// ─────────────────────────────────────────────────────────────────

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  action    String
  entity    String?
  entityId  String?  @map("entity_id") @db.Uuid
  details   Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
